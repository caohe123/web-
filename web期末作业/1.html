<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Då­—æ¯é—¯å…³ - çº¯å‡€ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }

        body {
            background: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* å¼€å§‹ç•Œé¢ */
        #start-screen {
            text-align: center;
            padding: 50px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            max-width: 700px;
        }

        #start-screen h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 36px;
        }

        /* æ¸¸æˆè¯´æ˜æ ·å¼ */
        #game-instructions {
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        #game-instructions h3 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 20px;
        }

        #game-instructions ul {
            list-style: none;
            padding-left: 10px;
        }

        #game-instructions li {
            margin: 8px 0;
            color: #34495e;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        #game-instructions li::before {
            content: "âœ“";
            color: #2ecc71;
            margin-right: 10px;
            font-weight: bold;
        }

        .btn {
            padding: 15px 40px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #start-btn {
            background: #3498db;
            color: #fff;
        }

        #start-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        /* æ¸¸æˆå®¹å™¨ */
        #game-container {
            display: none;
            text-align: center;
        }

        /* æ¸¸æˆä¿¡æ¯é¢æ¿ */
        #game-info {
            background: #2c3e50;
            color: #fff;
            padding: 15px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            min-width: 500px;
            display: flex;
            justify-content: space-between;
        }

        .info-item {
            margin: 0 10px;
        }

        #target-word {
            color: #f1c40f;
            font-size: 24px;
            font-weight: bold;
        }

        /* æ¸¸æˆé¢æ¿ */
        #game-board {
            display: grid;
            grid-template-columns: repeat(15, 40px);
            grid-template-rows: repeat(12, 40px);
            gap: 2px;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
        }

        /* æ ¼å­æ ·å¼ */
        .cell {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }

        .floor {
            background: #bdc3c7;
        }

        /* ç›®æ ‡åŒº */
        .target {
            background: #f1c40f;
            border: 2px dashed #e67e22;
        }

        /* ç©å®¶ */
        .player {
            background: #3498db;
            border-radius: 50%;
            z-index: 10;
        }

        /* å­—æ¯ç®±å­ */
        .letter-box {
            background: #e74c3c;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .letter-box.grabbed {
            background: #9b59b6;
            box-shadow: 0 0 10px #9b59b6;
            z-index: 15;
        }

        .letter-box.on-target {
            background: #2ecc71;
        }

        /* å¼¹çª—æ ·å¼ */
        #next-level-modal, #success-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
            text-align: center;
            display: none;
            z-index: 100;
        }

        #success-modal h2 {
            color: #27ae60;
            margin-bottom: 20px;
            font-size: 32px;
        }

        #final-score {
            font-size: 28px;
            color: #e67e22;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <!-- å¼€å§‹ç•Œé¢ï¼ˆæ–°å¢æ¸¸æˆè¯´æ˜ï¼‰ -->
    <div id="start-screen">
        <h1>2Då­—æ¯é—¯å…³ - çº¯å‡€ç‰ˆ</h1>
        
        <!-- æ¸¸æˆè¯´æ˜åŒºåŸŸ -->
        <div id="game-instructions">
            <h3>ğŸ® æ¸¸æˆç©æ³•è¯´æ˜</h3>
            <ul>
                <li>æ–¹å‘é”® â†‘â†“â†â†’ æ§åˆ¶è§’è‰²ç§»åŠ¨</li>
                <li>ç©ºæ ¼é”®ï¼šé è¿‘å­—æ¯ç®±å­æ—¶æŠ“å–/é‡Šæ”¾ç®±å­</li>
                <li>æŠ“å–çš„ç®±å­ä¼šè·Ÿéšè§’è‰²ç§»åŠ¨ï¼Œé‡Šæ”¾åç•™åœ¨å½“å‰ä½ç½®</li>
                <li>æŒ‰ç›®æ ‡å•è¯é¡ºåºå°†å­—æ¯ç®±å­æ”¾å…¥é»„è‰²ç›®æ ‡åŒºï¼ˆå­—æ¯å˜ç»¿å³ä¸ºæ­£ç¡®ï¼‰</li>
                <li>å…¨éƒ¨å­—æ¯æŒ‰é¡ºåºæ”¾å¯¹å³å¯é€šå…³ï¼Œç”¨æ—¶è¶ŠçŸ­å¾—åˆ†è¶Šé«˜</li>
            </ul>
        </div>

        <button id="start-btn" class="btn">å¼€å§‹æ¸¸æˆ</button>
    </div>

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        <div id="game-info">
            <div class="info-item">å…³å¡ï¼š<span id="level">1</span></div>
            <div class="info-item">ç›®æ ‡ï¼š<span id="target-word">APPLE</span></div>
            <div class="info-item">åˆ†æ•°ï¼š<span id="score">0</span></div>
            <div class="info-item">ç”¨æ—¶ï¼š<span id="time">0</span>s</div>
        </div>
        <div id="game-board"></div>
    </div>

    <!-- ä¸‹ä¸€å…³å¼¹çª— -->
    <div id="next-level-modal">
        <h3>æ­å–œé€šå…³æœ¬å…³ï¼</h3>
        <div>æœ¬å…³å¾—åˆ†ï¼š<span id="next-score">0</span></div>
        <button id="next-btn" class="btn">ä¸‹ä¸€å…³</button>
    </div>

    <!-- é€šå…³å¼¹çª— -->
    <div id="success-modal">
        <h2>æ­å–œé€šå…³æ‰€æœ‰å…³å¡ï¼ğŸ‰</h2>
        <div>æœ€ç»ˆå¾—åˆ†ï¼š<span id="final-score">0</span></div>
        <button id="restart-btn" class="btn">é‡æ–°å¼€å§‹</button>
    </div>

    <script>
        // ===================== æ ¸å¿ƒé…ç½® =====================
        // å¤šå•è¯é¢˜åº“
        const WORD_LIBRARY = [
            { word: "APPLE", length: 5 },   // å…³å¡1
            { word: "BANANA", length: 6 },  // å…³å¡2
            { word: "ORANGE", length: 6 },  // å…³å¡3
            { word: "GRAPE", length: 5 },   // å…³å¡4
            { word: "PEAR", length: 4 }     // å…³å¡5
        ];

        const GAME_CONFIG = {
            rows: 12,
            cols: 15,
            playerStartPos: { x: 7, y: 5 }, // ç©å®¶åˆå§‹ä½ç½®ï¼ˆä¸­å¤®ï¼‰
            grabRange: 1,                   // æŠ“å–èŒƒå›´ï¼ˆ1æ ¼å†…ï¼‰
            targetAreaY: 2                  // ç›®æ ‡åŒºYåæ ‡ï¼ˆå›ºå®šåœ¨ä¸Šæ–¹ï¼‰
        };

        // ===================== å…¨å±€å˜é‡ =====================
        let currentLevel = 1;
        let totalScore = 0;
        let startTime = 0;
        let timeCounter = null;
        let currentTime = 0;

        let playerPos = {};
        let currentWord = "";
        let currentWordLength = 0;
        let collectedLetters = [];
        let targetPoints = {}; // ç›®æ ‡åŒºæ ¼å­æ˜ å°„
        let gameCells = [];

        // å­—æ¯ç®±å­çŠ¶æ€
        let letterBoxes = {}; // {x,y: {letter, grabbed: boolean}}
        let isGrabbing = false;
        let grabbedBoxKey = null; // å½“å‰æŠ“å–çš„ç®±å­åæ ‡é”®ï¼ˆx,yï¼‰

        // ===================== æ ¸å¿ƒåŠŸèƒ½ï¼šæŠ“å–/é‡Šæ”¾å­—æ¯ =====================
        function grabBox() {
            if (isGrabbing) return; // å·²æŠ“å–æ—¶ä¸é‡å¤æŠ“å–

            // æŸ¥æ‰¾ç©å®¶å‘¨å›´1æ ¼å†…çš„å­—æ¯ç®±å­
            const nearbyBoxes = getNearbyBoxes(playerPos, GAME_CONFIG.grabRange);
            if (nearbyBoxes.length === 0) return;

            // æŠ“å–æœ€è¿‘çš„ç®±å­
            grabbedBoxKey = nearbyBoxes[0];
            letterBoxes[grabbedBoxKey].grabbed = true;
            isGrabbing = true;

            // è§†è§‰åé¦ˆï¼šç®±å­å˜è‰²å‘å…‰
            const [x, y] = grabbedBoxKey.split(',').map(Number);
            gameCells[y][x].classList.add("grabbed");
        }

        function releaseBox() {
            if (!isGrabbing || !grabbedBoxKey) return;

            // å–æ¶ˆç®±å­æŠ“å–çŠ¶æ€
            letterBoxes[grabbedBoxKey].grabbed = false;
            isGrabbing = false;

            // è§†è§‰åé¦ˆï¼šç§»é™¤å˜è‰²å‘å…‰
            const [x, y] = grabbedBoxKey.split(',').map(Number);
            gameCells[y][x].classList.remove("grabbed");

            // æ£€æŸ¥ç®±å­æ˜¯å¦åœ¨ç›®æ ‡åŒº
            checkTargetArea(grabbedBoxKey);
            grabbedBoxKey = null;
        }

        // ===================== è¾…åŠ©å‡½æ•° =====================
        // è·å–ç©å®¶å‘¨å›´èŒƒå›´å†…çš„å­—æ¯ç®±å­
        function getNearbyBoxes(pos, range) {
            const boxes = [];
            const { x: px, y: py } = pos;

            // éå†å‘¨å›´rangeæ ¼
            for (let y = py - range; y <= py + range; y++) {
                for (let x = px - range; x <= px + range; x++) {
                    if (x < 0 || x >= GAME_CONFIG.cols || y < 0 || y >= GAME_CONFIG.rows) continue;
                    if (x === px && y === py) continue; // æ’é™¤ç©å®¶è‡ªèº«ä½ç½®

                    const key = `${x},${y}`;
                    if (letterBoxes[key] && !letterBoxes[key].grabbed) {
                        boxes.push(key);
                    }
                }
            }
            return boxes;
        }

        // ç”Ÿæˆå­—æ¯ç®±å­ä½ç½®ï¼ˆå›´ç»•ç©å®¶å’Œç›®æ ‡åŒºåˆ†å¸ƒï¼Œé¿å…é‡å ï¼‰
        function generateLetterPositions() {
            letterBoxes = {};
            const letters = currentWord.split('');
            const candidatePositions = [];

            // å€™é€‰ä½ç½®ï¼šç©å®¶å‘¨å›´å’Œç›®æ ‡åŒºå‘¨å›´
            const playerArea = [
                {x: 4, y: 4}, {x: 5, y: 6}, {x: 8, y: 4}, {x: 9, y: 6},
                {x: 3, y: 7}, {x: 10, y: 7}, {x: 6, y: 3}, {x: 7, y: 8}
            ];
            const targetArea = getTargetArea();
            targetArea.forEach(pos => {
                candidatePositions.push({x: pos.x - 2, y: pos.y + 2});
                candidatePositions.push({x: pos.x + 2, y: pos.y + 2});
                candidatePositions.push({x: pos.x, y: pos.y + 3});
            });

            // åˆå¹¶å€™é€‰ä½ç½®å¹¶å»é‡
            const allPositions = [...playerArea, ...targetArea, ...candidatePositions];
            const uniquePositions = Array.from(
                new Map(allPositions.map(pos => [`${pos.x},${pos.y}`, pos])).values()
            );

            // ä¸ºæ¯ä¸ªå­—æ¯åˆ†é…ä½ç½®
            letters.forEach((letter, index) => {
                const pos = uniquePositions[index % uniquePositions.length];
                const key = `${pos.x},${pos.y}`;
                letterBoxes[key] = {
                    letter: letter,
                    grabbed: false
                };
            });
        }

        // è·å–ä¸­å¤®ç›®æ ‡åŒºä½ç½®ï¼ˆæ°´å¹³å±…ä¸­ï¼‰
        function getTargetArea() {
            targetPoints = {};
            const startX = Math.floor((GAME_CONFIG.cols - currentWordLength) / 2);
            const area = [];

            for (let i = 0; i < currentWordLength; i++) {
                const x = startX + i;
                const y = GAME_CONFIG.targetAreaY;
                area.push({x, y});
                targetPoints[`${x},${y}`] = {
                    letter: currentWord[i],
                    index: i
                };
            }
            return area;
        }

        // æ£€æŸ¥å­—æ¯ç®±å­æ˜¯å¦åœ¨ç›®æ ‡åŒº
        function checkTargetArea(boxKey) {
            const [x, y] = boxKey.split(',').map(Number);
            const targetKey = `${x},${y}`;

            if (targetPoints[targetKey]) {
                const box = letterBoxes[boxKey];
                const target = targetPoints[targetKey];

                // å¿…é¡»æŒ‰é¡ºåºæ”¶é›†å­—æ¯
                if (box.letter === target.letter && collectedLetters.length === target.index) {
                    collectedLetters.push(box.letter);
                    gameCells[y][x].classList.add("on-target");

                    // æ£€æŸ¥é€šå…³
                    if (collectedLetters.join('') === currentWord) {
                        clearInterval(timeCounter);
                        calculateScore();
                    }
                }
            }
        }

        // è®¡ç®—æœ¬å…³å¾—åˆ†
        function calculateScore() {
            const baseScore = 1000;
            const speedScore = Math.max(0, 800 - currentTime * 10); // è¶Šå¿«åˆ†è¶Šé«˜
            const levelScore = baseScore + speedScore;
            totalScore += levelScore;

            document.getElementById('score').textContent = totalScore;

            // é€šå…³åˆ¤æ–­
            if (currentLevel >= WORD_LIBRARY.length) {
                document.getElementById('final-score').textContent = totalScore;
                setTimeout(() => document.getElementById('success-modal').style.display = 'block', 500);
            } else {
                document.getElementById('next-score').textContent = levelScore;
                setTimeout(() => document.getElementById('next-level-modal').style.display = 'block', 500);
            }
        }

        // ===================== åˆå§‹åŒ–æ¸¸æˆ =====================
        function initGame(level = 1) {
            // é‡ç½®çŠ¶æ€
            collectedLetters = [];
            targetPoints = {};
            gameCells = [];
            currentTime = 0;
            isGrabbing = false;
            grabbedBoxKey = null;

            // è®¾ç½®å½“å‰å…³å¡ä¿¡æ¯
            currentLevel = level;
            const wordData = WORD_LIBRARY[level - 1];
            currentWord = wordData.word;
            currentWordLength = wordData.length;

            // æ›´æ–°UI
            document.getElementById('level').textContent = currentLevel;
            document.getElementById('target-word').textContent = currentWord;
            document.getElementById('time').textContent = currentTime;
            document.getElementById('score').textContent = totalScore;

            // ç©å®¶åˆå§‹ä½ç½®
            playerPos = {...GAME_CONFIG.playerStartPos};

            // ç”Ÿæˆå­—æ¯ç®±å­å’Œç›®æ ‡åŒº
            generateLetterPositions();
            getTargetArea();

            // æ¸²æŸ“æ¸¸æˆé¢æ¿
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';

            for (let y = 0; y < GAME_CONFIG.rows; y++) {
                gameCells[y] = [];
                for (let x = 0; x < GAME_CONFIG.cols; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell floor';
                    cell.dataset.x = x;
                    cell.dataset.y = y;

                    // æ¸²æŸ“ç›®æ ‡åŒº
                    if (targetPoints[`${x},${y}`]) {
                        cell.classList.remove('floor');
                        cell.classList.add('target');
                    }

                    // æ¸²æŸ“ç©å®¶
                    if (x === playerPos.x && y === playerPos.y) {
                        cell.classList.remove('floor', 'target');
                        cell.classList.add('player');
                        cell.textContent = 'ğŸ˜€';
                    }

                    // æ¸²æŸ“å­—æ¯ç®±å­
                    const boxKey = `${x},${y}`;
                    if (letterBoxes[boxKey]) {
                        cell.classList.add('letter-box');
                        cell.textContent = letterBoxes[boxKey].letter;
                    }

                    gameBoard.appendChild(cell);
                    gameCells[y][x] = cell;
                }
            }

            // å¼€å§‹è®¡æ—¶
            startTime = Date.now();
            if (timeCounter) clearInterval(timeCounter);
            timeCounter = setInterval(() => {
                currentTime = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('time').textContent = currentTime;
            }, 1000);
        }

        // ===================== ç©å®¶ç§»åŠ¨é€»è¾‘ =====================
        function movePlayer(dx, dy) {
            const newX = playerPos.x + dx;
            const newY = playerPos.y + dy;

            // è¾¹ç•Œæ£€æµ‹
            if (newX < 0 || newX >= GAME_CONFIG.cols || newY < 0 || newY >= GAME_CONFIG.rows) return;

            // ç§»åŠ¨ç©å®¶
            updatePlayerPosition(newX, newY);

            // å¦‚æœæ­£åœ¨æŠ“å–ç®±å­ï¼ŒåŒæ­¥ç§»åŠ¨ç®±å­
            if (isGrabbing && grabbedBoxKey) {
                moveGrabbedBox(dx, dy);
            }
        }

        // æ›´æ–°ç©å®¶ä½ç½®ï¼ˆä¿®å¤æ¶ˆå¤±bugï¼‰
        function updatePlayerPosition(newX, newY) {
            // æ¸…é™¤æ—§ä½ç½®ç©å®¶æ ·å¼
            const oldX = playerPos.x;
            const oldY = playerPos.y;
            const oldCell = gameCells[oldY][oldX];
            oldCell.classList.remove('player');
            oldCell.textContent = '';

            // æ¢å¤æ—§ä½ç½®åœ°å½¢ï¼ˆç›®æ ‡åŒº/ç©ºåœ°ï¼‰
            if (targetPoints[`${oldX},${oldY}`]) {
                oldCell.classList.add('target');
            } else {
                oldCell.classList.add('floor');
            }

            // åœ¨æ–°ä½ç½®æ¸²æŸ“ç©å®¶
            const newCell = gameCells[newY][newX];
            newCell.classList.remove('floor', 'target');
            newCell.classList.add('player');
            newCell.textContent = 'ğŸ˜€';

            // æ›´æ–°ç©å®¶ä½ç½®
            playerPos.x = newX;
            playerPos.y = newY;
        }

        // ç§»åŠ¨æŠ“å–çš„å­—æ¯ç®±å­
        function moveGrabbedBox(dx, dy) {
            const [boxX, boxY] = grabbedBoxKey.split(',').map(Number);
            const newBoxX = boxX + dx;
            const newBoxY = boxY + dy;
            const newBoxKey = `${newBoxX},${newBoxY}`;

            // è¾¹ç•Œæ£€æµ‹å’Œç¢°æ’æ£€æµ‹ï¼ˆä¸èƒ½ç©¿è¿‡å…¶ä»–ç®±å­ï¼‰
            if (newBoxX < 0 || newBoxX >= GAME_CONFIG.cols || newBoxY < 0 || newBoxY >= GAME_CONFIG.rows) return;
            if (letterBoxes[newBoxKey] && !letterBoxes[newBoxKey].grabbed) return;

            // æ¸…é™¤æ—§ä½ç½®ç®±å­æ ·å¼
            const oldBoxCell = gameCells[boxY][boxX];
            oldBoxCell.classList.remove('letter-box', 'grabbed', 'on-target');
            oldBoxCell.textContent = '';
            // æ¢å¤æ—§ä½ç½®åœ°å½¢
            if (targetPoints[grabbedBoxKey]) {
                oldBoxCell.classList.add('target');
            } else {
                oldBoxCell.classList.add('floor');
            }

            // åœ¨æ–°ä½ç½®æ¸²æŸ“ç®±å­
            const newBoxCell = gameCells[newBoxY][newBoxX];
            newBoxCell.classList.add('letter-box', 'grabbed');
            newBoxCell.textContent = letterBoxes[grabbedBoxKey].letter;
            // å¦‚æœæ–°ä½ç½®æ˜¯ç›®æ ‡åŒºï¼Œæ ‡è®°å·²å®Œæˆ
            if (targetPoints[newBoxKey]) {
                newBoxCell.classList.add('on-target');
            }

            // æ›´æ–°ç®±å­æ˜ å°„
            delete letterBoxes[grabbedBoxKey];
            letterBoxes[newBoxKey] = {
                letter: newBoxCell.textContent,
                grabbed: true
            };
            grabbedBoxKey = newBoxKey;
        }

        // ===================== äº‹ä»¶ç›‘å¬ =====================
        // é”®ç›˜æ§åˆ¶ï¼šæ–¹å‘é”®ç§»åŠ¨ï¼Œç©ºæ ¼é”®æŠ“å–/é‡Šæ”¾
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp': movePlayer(0, -1); break;
                case 'ArrowDown': movePlayer(0, 1); break;
                case 'ArrowLeft': movePlayer(-1, 0); break;
                case 'ArrowRight': movePlayer(1, 0); break;
                case ' ': 
                    if (!isGrabbing) grabBox();
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === ' ') {
                releaseBox();
            }
        });

        // å¼€å§‹æ¸¸æˆ
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            totalScore = 0;
            initGame(1);
        });

        // ä¸‹ä¸€å…³
        document.getElementById('next-btn').addEventListener('click', () => {
            document.getElementById('next-level-modal').style.display = 'none';
            initGame(currentLevel + 1);
        });

        // é‡æ–°å¼€å§‹
        document.getElementById('restart-btn').addEventListener('click', () => {
            document.getElementById('success-modal').style.display = 'none';
            totalScore = 0;
            initGame(1);
        });
    </script>
</body>
</html>