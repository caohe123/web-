<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Då­—æ¯é—¯å…³ - çº¯å‡€ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        /* ===== å…³å¡é€‰æ‹©æ ·å¼ï¼ˆæ–°å¢ï¼‰ ===== */
        #level-select h2 {
            font-size: 26px;
            color: #2c3e50;
            margin-bottom: 25px;
        }

        #level-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        #level-buttons button {
            width: 140px;
            height: 60px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #6dd5fa, #3498db);
            color: #fff;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            transition: all 0.25s ease;
        }

        #level-buttons button:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }

        body {
            background: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        /* å¼€å§‹ç•Œé¢ */
        #start-screen {
            text-align: center;
            padding: 50px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            max-width: 700px;
        }

          #start-screen h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 36px;
        }

        /* æ¸¸æˆè¯´æ˜æ ·å¼ */
        #game-instructions {
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        #game-instructions h3 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 20px;
        }

        #game-instructions ul {
            list-style: none;
            padding-left: 10px;
        }

        #game-instructions li {
            margin: 8px 0;
            color: #34495e;
            font-size: 16px;
            display: flex;
            align-items: center;
        }

        #game-instructions li::before {
            content: "âœ“";
            color: #2ecc71;
            margin-right: 10px;
            font-weight: bold;
        }

        .btn {
            padding: 15px 40px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #start-btn {
            background: #3498db;
            color: #fff;
        }

        #start-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        /* æ¸¸æˆå®¹å™¨ */
        #game-container {
            display: none;
            text-align: center;
        }

        /* æ¸¸æˆä¿¡æ¯é¢æ¿ */
        #game-info {
            background: #2c3e50;
            color: #fff;
            padding: 15px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            min-width: 500px;
            display: flex;
            justify-content: space-between;
        }

        .info-item {
            margin: 0 10px;
        }

        #target-word {
            color: #f1c40f;
            font-size: 24px;
            font-weight: bold;
        }

        /* æ¸¸æˆé¢æ¿ */
        #game-board {
            display: grid;
            grid-template-columns: repeat(15, 40px);
            grid-template-rows: repeat(12, 40px);
            gap: 2px;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
        }

        /* æ ¼å­æ ·å¼ */
        .cell {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            user-select: none;
        }

        .floor {
            background: #bdc3c7;
        }

        /* ç›®æ ‡åŒº */
        .target {
            background: #f1c40f;
            border: 2px dashed #e67e22;
            color: #d35400;
        }

        /* ç©å®¶ */
        .player {
            background: #3498db;
            border-radius: 50%;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* å­—æ¯ç®±å­ */
        .letter-box {
            background: #e74c3c;
            border-radius: 4px;
            transition: all 0.2s ease;
            z-index: 5;
        }

        .letter-box.grabbed {
            background: #9b59b6;
            box-shadow: 0 0 10px #9b59b6;
            z-index: 15;
        }

        .letter-box.on-target {
            background: #2ecc71;
        }

              /* å¼¹çª—æ ·å¼ */
        #next-level-modal, #success-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
            text-align: center;
            display: none;
            z-index: 100;
        }

        #success-modal h2 {
            color: #27ae60;
            margin-bottom: 20px;
            font-size: 32px;
        }

        #final-score {
            font-size: 28px;
            color: #e67e22;
            margin: 15px 0;
        }
    </style>
</head>
<body>
<!-- å¼€å§‹ç•Œé¢ -->
<div id="start-screen">

    <h1>2Då­—æ¯é—¯å…³ - çº¯å‡€ç‰ˆ</h1>

    <div id="game-instructions">
        <h3>ğŸ® æ¸¸æˆç©æ³•è¯´æ˜</h3>
        <ul>
            <li>æ–¹å‘é”® â†‘â†“â†â†’ æ§åˆ¶è§’è‰²ç§»åŠ¨ï¼ˆå¯ç›´æ¥ç©¿è¿‡å­—æ¯ï¼‰</li>
            <li>ç©ºæ ¼é”®ï¼šä¼˜å…ˆæŠ“å–è„šä¸‹ç®±å­ï¼Œè‹¥æ— åˆ™æŠ“å–å‘¨å›´ç®±å­</li>
            <li>æŠ“å–çš„ç®±å­ä¼šè·Ÿéšè§’è‰²ç§»åŠ¨</li>
            <li>å½“è§’è‰²ä¸ç®±å­é‡åˆæ—¶ï¼Œè§’è‰²æ˜¾ç¤ºä¼˜å…ˆï¼ˆç®±å­è¢«é®æŒ¡ï¼‰</li>
            <li>æŒ‰ç›®æ ‡å•è¯é¡ºåºå°†å­—æ¯ç®±å­æ”¾å…¥é»„è‰²ç›®æ ‡åŒº</li>
        </ul>
    </div>

    <button id="start-btn" class="btn">å¼€å§‹æ¸¸æˆ</button>
    <!-- å…³å¡é€‰æ‹©ç•Œé¢ï¼ˆæ–°å¢ï¼‰ -->
    <div id="level-select" style="display:none; text-align:center; margin-top:30px;">
        <h2 style="margin-bottom:20px;">è¯·é€‰æ‹©å…³å¡</h2>
        <div id="level-buttons"></div>
    </div>
</div>

<!-- ===== æš‚åœèœå•ï¼ˆæ–°å¢ï¼‰ ===== -->
<div id="pause-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h2 style="margin-bottom:20px;">æ¸¸æˆå·²æš‚åœ</h2>
        <button id="resume-btn" class="btn">ç»§ç»­æ¸¸æˆ</button>
        <button id="exit-btn" class="btn" style="margin-top:10px;">é€€åˆ°ä¸»ç•Œé¢</button>
    </div>
</div>
<!-- æ¸¸æˆå®¹å™¨ -->
<div id="game-container">
    <div id="game-info">
        <div class="info-item">å…³å¡ï¼š<span id="level">1</span></div>
        <div class="info-item">ç›®æ ‡ï¼š<span id="target-word">APPLE</span></div>
        <div class="info-item">åˆ†æ•°ï¼š<span id="score">0</span></div>
        <div class="info-item">ç”¨æ—¶ï¼š<span id="time">0</span>s</div>
    </div>
    <div id="game-board"></div>
</div>

<!-- ä¸‹ä¸€å…³å¼¹çª— -->
<div id="next-level-modal">
    <h3>æ­å–œé€šå…³æœ¬å…³ï¼</h3>
    <div>æœ¬å…³å¾—åˆ†ï¼š<span id="next-score">0</span></div>
    <button id="next-btn" class="btn">ä¸‹ä¸€å…³</button>
</div>

<!-- é€šå…³å¼¹çª— -->
<div id="success-modal">
    <h2>æ­å–œé€šå…³æ‰€æœ‰å…³å¡ï¼ğŸ‰</h2>
    <div>æœ€ç»ˆå¾—åˆ†ï¼š<span id="final-score">0</span></div>
    <button id="restart-btn" class="btn">é‡æ–°å¼€å§‹</button>
</div>

<script>
    // ===== æ–°å¢ï¼šESC æš‚åœ/ç»§ç»­ =====
    document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;

        // æ¸¸æˆæœªå¼€å§‹ or é€šå…³å¼¹çª—æ‰“å¼€æ—¶ï¼Œä¸å“åº”
        if (document.getElementById('game-container').style.display !== 'block') return;

        if (!isPaused) {
            pauseGame();
        } else {
            resumeGame();
        }
    });

    // ===================== æ ¸å¿ƒé…ç½® =====================
    const WORD_LIBRARY = [
        { word: "APPLE", length: 5 },
        { word: "BANANA", length: 6 },
        { word: "ORANGE", length: 6 },
        { word: "GRAPE", length: 5 },
        { word: "PEAR", length: 4 }
    ];
    // ===== æ–°å¢ï¼šç”Ÿæˆå…³å¡é€‰æ‹©æŒ‰é’® =====

    function buildLevelSelect() {
        const container = document.getElementById('level-buttons');
        container.innerHTML = '';

        WORD_LIBRARY.forEach((item, index) => {
            const btn = document.createElement('button');
            btn.textContent = `ç¬¬ ${index + 1} å…³`;

            btn.onclick = () => {
                document.getElementById('level-select').style.display = 'none';
                document.getElementById('game-container').style.display = 'block';
                totalScore = 0;
                initGame(index + 1);
            };

            container.appendChild(btn);
        });
    }

    // ===== å•è¯ä¸­æ–‡é‡Šä¹‰ï¼ˆæ–°å¢ï¼Œä¸å½±å“åŸé€»è¾‘ï¼‰=====
    const WORD_MEANINGS = {
        APPLE: "è‹¹æœ",
        BANANA: "é¦™è•‰",
        ORANGE: "æ©™å­",
        GRAPE: "è‘¡è„",
        PEAR: "æ¢¨"
    };
    function pauseGame() {
        if (isPaused) return;

        isPaused = true;

        // âœ… è®°å½•å·²ç”¨æ—¶é—´
        pausedTime = Date.now() - startTime;

        // âœ… åœæ­¢è®¡æ—¶å™¨
        clearInterval(timeCounter);

        document.getElementById('pause-modal').style.display = 'block';
    }


    function resumeGame() {
        if (!isPaused) return;

        isPaused = false;

        // âœ… æ¢å¤å¼€å§‹æ—¶é—´ï¼ˆä»æš‚åœç‚¹ç»§ç»­ï¼‰
        startTime = Date.now() - pausedTime;

        // âœ… é‡æ–°å¯åŠ¨è®¡æ—¶å™¨
        timeCounter = setInterval(() => {
            currentTime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('time').textContent = currentTime;
        }, 1000);

        document.getElementById('pause-modal').style.display = 'none';
    }


    // ===== å•è¯å‘éŸ³ï¼ˆæ–°å¢ï¼‰=====
    function speakWord(word) {
        if (!window.speechSynthesis) return;
        const utter = new SpeechSynthesisUtterance(word);
        utter.lang = "en-US";
        utter.rate = 0.9;
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
    }
    const GAME_CONFIG = {
        rows: 12,
        cols: 15,
        playerStartPos: { x: 7, y: 5 },
        grabRange: 1,
        targetAreaY: 2
    };

    // ===================== å…¨å±€å˜é‡ =====================
    let currentLevel = 1;
    let totalScore = 0;
    let startTime = 0;
    let timeCounter = null;
    let currentTime = 0;
    let pausedTime = 0; // â† è®°å½•æš‚åœæ—¶å·²ç”¨æ—¶é—´
    let playerPos = {};
    let currentWord = "";
    let currentWordLength = 0;
    let collectedLetters = [];
    let targetPoints = {};
    let gameCells = [];

    let letterBoxes = {};
    let isGrabbing = false;
    let grabbedBoxKey = null;
    let isPaused = false;


    // ===================== æ ¸å¿ƒåŠŸèƒ½ï¼šæŠ“å–/é‡Šæ”¾ =====================
    function grabBox() {
        if (isGrabbing) return;

        const currentKey = `${playerPos.x},${playerPos.y}`;

        // 1. ã€ä¼˜å…ˆã€‘æ£€æŸ¥è„šä¸‹æ˜¯å¦æœ‰ç®±å­
        if (letterBoxes[currentKey] && !letterBoxes[currentKey].grabbed) {
            grabbedBoxKey = currentKey;
            letterBoxes[grabbedBoxKey].grabbed = true;
            isGrabbing = true;

            // è§†è§‰åé¦ˆ
            gameCells[playerPos.y][playerPos.x].classList.add("grabbed");
            return;
        }

        // 2. ã€å¤‡é€‰ã€‘æœç´¢å‘¨å›´
        const nearbyBoxes = getNearbyBoxes(playerPos, GAME_CONFIG.grabRange);
        if (nearbyBoxes.length === 0) return;

        grabbedBoxKey = nearbyBoxes[0];
        letterBoxes[grabbedBoxKey].grabbed = true;
        isGrabbing = true;

        const [x, y] = grabbedBoxKey.split(',').map(Number);
        gameCells[y][x].classList.add("grabbed");
    }

    function releaseBox() {
        if (!isGrabbing || !grabbedBoxKey) return;
        letterBoxes[grabbedBoxKey].grabbed = false;
        isGrabbing = false;

        const [x, y] = grabbedBoxKey.split(',').map(Number);

        if (playerPos.x !== x || playerPos.y !== y) {
            gameCells[y][x].classList.remove("grabbed");
        } else {
            // ç©å®¶ç«™åœ¨è¿™ï¼Œä¿æŒ player æ ·å¼ï¼Œä½†æ•°æ®å·²æ”¾ä¸‹
            gameCells[y][x].classList.remove("grabbed");
        }

        checkTargetArea(grabbedBoxKey);
        grabbedBoxKey = null;
    }

    function getNearbyBoxes(pos, range) {
        const boxes = [];
        const { x: px, y: py } = pos;
        for (let y = py - range; y <= py + range; y++) {
            for (let x = px - range; x <= px + range; x++) {
                if (x < 0 || x >= GAME_CONFIG.cols || y < 0 || y >= GAME_CONFIG.rows) continue;
                if (x === px && y === py) continue;

                const key = `${x},${y}`;
                if (letterBoxes[key] && !letterBoxes[key].grabbed) {
                    boxes.push(key);
                }
            }
        }
        return boxes;
    }

    function generateLetterPositions() {
        letterBoxes = {};
        const letters = currentWord.split('');
        const candidatePositions = [];
        const playerArea = [
            {x: 4, y: 4}, {x: 5, y: 6}, {x: 8, y: 4}, {x: 9, y: 6},
            {x: 3, y: 7}, {x: 10, y: 7}, {x: 6, y: 3}, {x: 7, y: 8}
        ];
        const targetArea = getTargetArea();
        targetArea.forEach(pos => {
            candidatePositions.push({x: pos.x - 2, y: pos.y + 2});
            candidatePositions.push({x: pos.x + 2, y: pos.y + 2});
            candidatePositions.push({x: pos.x, y: pos.y + 3});
        });

        const allPositions = [...playerArea, ...targetArea, ...candidatePositions];
        const uniquePositions = Array.from(
            new Map(allPositions.map(pos => [`${pos.x},${pos.y}`, pos])).values()
        );

        letters.forEach((letter, index) => {
            const pos = uniquePositions[index % uniquePositions.length];
            const key = `${pos.x},${pos.y}`;
            letterBoxes[key] = {
                letter: letter,
                grabbed: false
            };
        });
    }

    function getTargetArea() {
        targetPoints = {};
        const startX = Math.floor((GAME_CONFIG.cols - currentWordLength) / 2);
        const area = [];
        for (let i = 0; i < currentWordLength; i++) {
            const x = startX + i;
            const y = GAME_CONFIG.targetAreaY;
            area.push({x, y});
            targetPoints[`${x},${y}`] = {
                letter: currentWord[i],
                index: i
            };
        }
        return area;
    }

    function checkTargetArea(boxKey) {
        const [x, y] = boxKey.split(',').map(Number);
        const targetKey = `${x},${y}`;
        if (targetPoints[targetKey]) {
            const box = letterBoxes[boxKey];
            const target = targetPoints[targetKey];
            if (box.letter === target.letter && collectedLetters.length === target.index) {
                collectedLetters.push(box.letter);
                if (playerPos.x !== x || playerPos.y !== y) {
                    gameCells[y][x].classList.add("on-target");
                }
                if (collectedLetters.join('') === currentWord) {
                    clearInterval(timeCounter);
                    // ===== æ–°å¢ï¼šæ˜¾ç¤ºä¸­æ–‡ + å‘éŸ³ =====
                    const meaning = WORD_MEANINGS[currentWord] || "ï¼ˆæš‚æ— é‡Šä¹‰ï¼‰";
                    const meaningText = `${currentWord} ï¼š${meaning}`;
                    document.getElementById('next-score').insertAdjacentHTML(
                        "beforebegin",
                        `<div style="margin:10px 0;font-size:18px;color:#34495e;">${meaningText}</div>`
                    );
                    speakWord(currentWord);
                    calculateScore();
                }
            }
        }
    }

    function calculateScore() {
        const baseScore = 1000;
        const speedScore = Math.max(0, 800 - currentTime * 10);
        const levelScore = baseScore + speedScore;
        totalScore += levelScore;
        document.getElementById('score').textContent = totalScore;
        if (currentLevel >= WORD_LIBRARY.length) {
            document.getElementById('final-score').textContent = totalScore;
            setTimeout(() => document.getElementById('success-modal').style.display = 'block', 500);
        } else {
            document.getElementById('next-score').textContent = levelScore;
            setTimeout(() => document.getElementById('next-level-modal').style.display = 'block', 500);
        }
    }

    function initGame(level = 1) {
        collectedLetters = [];
        targetPoints = {};
        gameCells = [];
        currentTime = 0;
        isGrabbing = false;
        grabbedBoxKey = null;
        pausedTime = 0; // â† é˜²æ­¢ä¸Šä¸€å…³å½±å“
        currentLevel = level;
        const wordData = WORD_LIBRARY[level - 1];
        currentWord = wordData.word;
        currentWordLength = wordData.length;
        document.getElementById('level').textContent = currentLevel;
        document.getElementById('target-word').textContent = currentWord;
        document.getElementById('time').textContent = currentTime;
        document.getElementById('score').textContent = totalScore;
        playerPos = {...GAME_CONFIG.playerStartPos};
        generateLetterPositions();
        getTargetArea();
        const gameBoard = document.getElementById('game-board');
        gameBoard.innerHTML = '';
        for (let y = 0; y < GAME_CONFIG.rows; y++) {
            gameCells[y] = [];
            for (let x = 0; x < GAME_CONFIG.cols; x++) {
                const cell = document.createElement('div');
                cell.className = 'cell floor';
                cell.dataset.x = x;
                cell.dataset.y = y;
                if (targetPoints[`${x},${y}`]) {
                    cell.classList.remove('floor');
                    cell.classList.add('target');
                    cell.textContent = '?';
                }
                const boxKey = `${x},${y}`;
                if (letterBoxes[boxKey]) {
                    cell.classList.add('letter-box');
                    cell.textContent = letterBoxes[boxKey].letter;
                }
                if (x === playerPos.x && y === playerPos.y) {
                    cell.className = 'cell player';
                    cell.textContent = 'ğŸ˜€';
                }
                gameBoard.appendChild(cell);
                gameCells[y][x] = cell;
            }
        }
        startTime = Date.now();
        if (timeCounter) clearInterval(timeCounter);
        timeCounter = setInterval(() => {
            currentTime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('time').textContent = currentTime;
        }, 1000);
    }

    // ===================== ç©å®¶ç§»åŠ¨é€»è¾‘ =====================
    function movePlayer(dx, dy) {
        if (isPaused) return;
        const newX = playerPos.x + dx;
        const newY = playerPos.y + dy;

        if (newX < 0 || newX >= GAME_CONFIG.cols || newY < 0 || newY >= GAME_CONFIG.rows) return;

        updatePlayerPosition(newX, newY);

        if (isGrabbing && grabbedBoxKey) {
            moveGrabbedBox(dx, dy);
        }
    }

    function updatePlayerPosition(newX, newY) {
        const oldX = playerPos.x;
        const oldY = playerPos.y;
        const oldKey = `${oldX},${oldY}`;
        const oldCell = gameCells[oldY][oldX];

        oldCell.classList.remove('player');
        oldCell.textContent = '';

        if (letterBoxes[oldKey]) {
            oldCell.classList.add('letter-box');
            oldCell.textContent = letterBoxes[oldKey].letter;
            if (letterBoxes[oldKey].grabbed) oldCell.classList.add('grabbed');
            if (targetPoints[oldKey] && collectedLetters.includes(letterBoxes[oldKey].letter)) {
                oldCell.classList.add('on-target');
            }
        } else {
            if (targetPoints[oldKey]) {
                oldCell.classList.add('target');
                oldCell.textContent = '?';
            } else {
                oldCell.classList.add('floor');
            }
        }

        const newCell = gameCells[newY][newX];
        newCell.className = 'cell player';
        newCell.textContent = 'ğŸ˜€';

        playerPos.x = newX;
        playerPos.y = newY;
    }

    // ç§»åŠ¨è¢«æŠ“å–çš„ç®±å­ (ä¿®å¤æ•°æ®ä¸¢å¤±bug)
    function moveGrabbedBox(dx, dy) {
        const [boxX, boxY] = grabbedBoxKey.split(',').map(Number);
        const newBoxX = boxX + dx;
        const newBoxY = boxY + dy;
        const newBoxKey = `${newBoxX},${newBoxY}`;

        if (newBoxX < 0 || newBoxX >= GAME_CONFIG.cols || newBoxY < 0 || newBoxY >= GAME_CONFIG.rows) return;
        if (letterBoxes[newBoxKey] && !letterBoxes[newBoxKey].grabbed) return;

        // ã€ä¿®å¤ç‚¹ã€‘å…ˆä¿å­˜å½“å‰ç®±å­çš„å­—æ¯å†…å®¹ï¼Œé˜²æ­¢åˆ é™¤åä¸¢å¤±
        const currentLetter = letterBoxes[grabbedBoxKey].letter;

        // æ¢å¤æ—§ç®±å­ä½ç½®
        const oldBoxCell = gameCells[boxY][boxX];
        oldBoxCell.classList.remove('letter-box', 'grabbed', 'on-target');

        if (boxX !== playerPos.x || boxY !== playerPos.y) {
            oldBoxCell.textContent = '';
            if (targetPoints[grabbedBoxKey]) {
                oldBoxCell.classList.add('target');
                oldBoxCell.textContent = '?';
            } else {
                oldBoxCell.classList.add('floor');
            }
        }

        // æ›´æ–°æ•°æ®ï¼šåˆ é™¤æ—§ä½ç½®ï¼Œæ·»åŠ åˆ°æ–°ä½ç½®
        delete letterBoxes[grabbedBoxKey];
        letterBoxes[newBoxKey] = {
            letter: currentLetter, // ä½¿ç”¨ä¿å­˜çš„å­—æ¯
            grabbed: true
        };

        // æ¸²æŸ“æ–°ç®±å­ä½ç½®
        const isPlayerHere = (newBoxX === playerPos.x && newBoxY === playerPos.y);

        if (!isPlayerHere) {
            const newBoxCell = gameCells[newBoxY][newBoxX];
            newBoxCell.className = 'cell letter-box grabbed';
            newBoxCell.textContent = currentLetter;

            if (targetPoints[newBoxKey]) {
                newBoxCell.classList.add('on-target');
            }
        }

        grabbedBoxKey = newBoxKey;
    }

    // ===================== äº‹ä»¶ç›‘å¬ =====================
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('next-level-modal').style.display === 'block' ||
            document.getElementById('success-modal').style.display === 'block') {
            return;
        }
        switch(e.key) {
            case 'ArrowUp': movePlayer(0, -1); e.preventDefault(); break;
            case 'ArrowDown': movePlayer(0, 1); e.preventDefault(); break;
            case 'ArrowLeft': movePlayer(-1, 0); e.preventDefault(); break;
            case 'ArrowRight': movePlayer(1, 0); e.preventDefault(); break;
            case ' ':
                e.preventDefault();
                if (!isGrabbing) grabBox();
                break;
        }
    });

    document.addEventListener('keyup', (e) => {
        if (e.key === ' ') {
            releaseBox();
        }
    });

    // ç»§ç»­æ¸¸æˆ
    document.getElementById('resume-btn').addEventListener('click', () => {
        resumeGame();
    });
    document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('game-instructions').style.display = 'none';
        document.getElementById('level-select').style.display = 'block';
        buildLevelSelect();
    });

    // é€€åˆ°ä¸»ç•Œé¢
    document.getElementById('exit-btn').addEventListener('click', () => {
        isPaused = false;

        document.getElementById('pause-modal').style.display = 'none';
        document.getElementById('game-container').style.display = 'none';

        // å›åˆ°å¼€å§‹ç•Œé¢
        document.getElementById('start-btn').style.display = 'inline-block';
        document.getElementById('game-instructions').style.display = 'block';
        document.getElementById('level-select').style.display = 'none';
    });


    // ===== æ–°å¢ï¼šæ¸…ç©ºâ€œé€šå…³æœ¬å…³â€å¼¹çª—é‡Œçš„ä¸­è‹±æ–‡ =====
    const modal = document.getElementById('next-level-modal');
    modal.querySelectorAll('.word-meaning').forEach(el => el.remove());

    document.getElementById('next-btn').addEventListener('click', () => {
        document.getElementById('next-level-modal').style.display = 'none';
        initGame(currentLevel + 1);
    });

    document.getElementById('restart-btn').addEventListener('click', () => {
        document.getElementById('success-modal').style.display = 'none';
        totalScore = 0;
        initGame(1);
    });
</script>
</body>
</html>
