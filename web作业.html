<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒç´ å•è¯å¤§ä½œæˆ˜ - ç«æŠ€ç‰ˆ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #1a1a1a;
            color: #fff;
            font-family: 'ZCOOL KuaiLe', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* å¼€å§‹ç•Œé¢ */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #start-screen h1 {
            font-size: 56px;
            color: #f1c40f;
            text-shadow: 4px 4px #e67e22, 8px 8px #000;
            margin-bottom: 30px;
        }

        .instruction-box {
            background: #333;
            border: 4px solid #fff;
            padding: 20px 40px;
            text-align: left;
            margin-bottom: 30px;
            box-shadow: 8px 8px 0px #000;
        }

        .btn-pixel {
            padding: 15px 40px;
            font-size: 28px;
            font-family: inherit;
            background: #2ecc71;
            color: #fff;
            border: 5px solid #000;
            cursor: pointer;
            box-shadow: 4px 4px 0px #27ae60;
        }

        /* æ¸¸æˆä¸»ä½“ */
        #game-container {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
        }

        #timer-bar {
            background: #c0392b;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border-bottom: 4px solid #000;
        }

        #main-game {
            display: flex;
            flex: 1;
        }

        .player-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #222;
        }

        #center-ui {
            width: 200px;
            background: #333;
            border-left: 4px solid #000;
            border-right: 4px solid #000;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            padding: 10px;
        }

        .word-box {
            background: #000; border: 2px solid #f1c40f;
            padding: 10px; width: 100%; margin: 10px 0;
            text-align: center;
        }

        .word-text { font-size: 20px; color: #fff; text-shadow: 2px 2px #e67e22; letter-spacing: 2px;}
        .score-val { font-size: 40px; color: #2ecc71; text-shadow: 3px 3px #000; }

        .game-board {
            display: grid;
            grid-template-columns: repeat(11, 40px);
            grid-template-rows: repeat(9, 40px);
            gap: 2px;
            background: #000;
            border: 4px solid #444;
        }

        .cell { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .floor { background: #333; }
        
        .letter-box {
            background: #e74c3c;
            border: 3px solid #000;
            box-shadow: inset -4px -4px 0px rgba(0,0,0,0.3), 2px 2px 0px #000;
            color: white;
            z-index: 5;
        }

        .player {
            z-index: 10; font-size: 26px;
            border: 3px solid #000;
            box-shadow: inset -4px -4px 0px rgba(0,0,0,0.3);
        }
        .p1-color { background: #3498db; }
        .p2-color { background: #9b59b6; }

        .target { background: #444; border: 2px dashed #555; color: #777; font-size: 14px; }
        .on-target { background: #2ecc71 !important; border: 3px solid #000 !important; color: white !important; font-size: 20px; }

        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; color: #000; padding: 40px; border: 8px solid #000; text-align: center;
            z-index: 2000; display: none;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>å­—æ¯å¤§å¯¹æˆ˜</h1>
        <div class="instruction-box">
            <p>ğŸ•¹ï¸ <b>P1 (å·¦):</b> WASD ç§»åŠ¨</p>
            <p>ğŸ•¹ï¸ <b>P2 (å³):</b> æ–¹å‘é”® ç§»åŠ¨</p>
            <p>ğŸ’¡ <b>è§„åˆ™:</b> æ¨å…¥ç›®æ ‡å•è¯å¯¹åº”çš„ä½ç½®å³å¯ï¼ˆä¸é™é¡ºåºï¼‰</p>
            <p>âš ï¸ <b>æç¤º:</b> å­—æ¯ç°åœ¨ç”Ÿæˆæ›´åˆ†æ•£ï¼Œæ—¶é—´æ›´é•¿ï¼Œå°½æƒ…å¯¹æˆ˜ï¼</p>
        </div>
        <button class="btn-pixel" onclick="startGame()">è¿›å…¥å¯¹æˆ˜</button>
    </div>

    <div id="game-container">
        <div id="timer-bar">å‰©ä½™æ—¶é—´: <span id="time-left">120</span>s</div>
        <div id="main-game">
            <div class="player-side"><div id="p1-board" class="game-board"></div></div>
            <div id="center-ui">
                <div>
                    <div style="color:#f1c40f; font-size:12px;">P1 ç›®æ ‡</div>
                    <div class="word-box"><div id="p1-word-display" class="word-text">-</div></div>
                    <div id="p1-score" class="score-val">0</div>
                </div>
                <div style="border-top: 2px solid #555; width: 80%;"></div>
                <div>
                    <div style="color:#f1c40f; font-size:12px;">P2 ç›®æ ‡</div>
                    <div class="word-box"><div id="p2-word-display" class="word-text">-</div></div>
                    <div id="p2-score" class="score-val">0</div>
                </div>
            </div>
            <div class="player-side"><div id="p2-board" class="game-board"></div></div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <h1 id="winner-msg">æ¸¸æˆç»“æŸ</h1>
        <p id="final-stats" style="margin: 20px 0; font-size: 24px;"></p>
        <button class="btn-pixel" onclick="location.reload()" style="font-size:20px;">å†æ¥ä¸€å±€</button>
    </div>

    <script>
        const WORD_POOL = {
            5: ["APPLE", "BOARD", "CLOCK", "DREAM", "ENTRY", "FIELD", "GLASS", "HEART", "IMAGE", "JUDGE"],
            6: ["ACTION", "BRIDGE", "CAMERA", "DANGER", "ENERGY", "FUTURE", "GARDEN", "HEALTH", "MEMORY", "NATURE"],
            7: ["ABILITY", "BEYOND", "CENTRAL", "DISPLAY", "EXAMPLE", "HISTORY", "JUSTICE", "LIBRARY", "MESSAGE", "PERFECT"]
        };

        const CONFIG = { rows: 9, cols: 11, gameTime: 120 };
        let players = {
            p1: { pos: {x:5, y:4}, boxes: {}, word: "", finishedIndices: [], score: 0, boardId: 'p1-board' },
            p2: { pos: {x:5, y:4}, boxes: {}, word: "", finishedIndices: [], score: 0, boardId: 'p2-board' }
        };
        let timeLeft = CONFIG.gameTime;
        let gameActive = false;
        let matchLength = 6;

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            matchLength = [5, 6, 7][Math.floor(Math.random() * 3)];
            gameActive = true;
            initPlayer('p1');
            initPlayer('p2');

            const timer = setInterval(() => {
                if (!gameActive) { clearInterval(timer); return; }
                timeLeft--;
                document.getElementById('time-left').textContent = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function initPlayer(pId) {
            const p = players[pId];
            p.word = WORD_POOL[matchLength][Math.floor(Math.random() * WORD_POOL[matchLength].length)];
            p.finishedIndices = [];
            p.boxes = {};
            p.pos = {x: 5, y: 5};
            document.getElementById(`${pId}-word-display`).textContent = p.word;

            const letters = p.word.split('');
            letters.forEach((char, idx) => {
                let rx, ry;
                let isInvalid = true;
                while (isInvalid) {
                    rx = Math.floor(Math.random() * (CONFIG.cols - 2)) + 1;
                    ry = Math.floor(Math.random() * (CONFIG.rows - 3)) + 2;
                    
                    // 1. é¿å¼€å‡ºç”Ÿç‚¹ 2. é¿å¼€å·²æœ‰çš„ç®±å­ 3. å¼ºåˆ¶ç®±å­ä¹‹é—´ä¸ç›¸é‚» (å…³é”®ä¿®æ”¹ï¼šé˜²4*4)
                    const inCenter = (rx >= 4 && rx <= 6 && ry >= 4 && ry <= 6);
                    let tooClose = false;
                    for(let key in p.boxes) {
                        let [bx, by] = key.split(',').map(Number);
                        if(Math.abs(bx-rx) <= 1 && Math.abs(by-ry) <= 1) tooClose = true;
                    }
                    if (!p.boxes[`${rx},${ry}`] && !inCenter && !tooClose) isInvalid = false;
                }
                p.boxes[`${rx},${ry}`] = { char, targetIdx: idx };
            });
            render(pId);
        }

        function render(pId) {
            const p = players[pId];
            const board = document.getElementById(p.boardId);
            board.innerHTML = '';
            const startX = Math.floor((CONFIG.cols - p.word.length) / 2);

            for (let y = 0; y < CONFIG.rows; y++) {
                for (let x = 0; x < CONFIG.cols; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell floor';

                    if (y === 0 && x >= startX && x < startX + p.word.length) {
                        const idx = x - startX;
                        cell.classList.add('target');
                        if (p.finishedIndices.includes(idx)) {
                            cell.classList.add('on-target');
                            cell.textContent = p.word[idx];
                        } else {
                            cell.textContent = p.word[idx]; // æç¤ºè¯¥ä½ç½®è¦ä»€ä¹ˆå­—æ¯
                        }
                    }

                    const box = p.boxes[`${x},${y}`];
                    if (box) {
                        cell.classList.add('letter-box');
                        cell.textContent = box.char;
                    }

                    if (x === p.pos.x && y === p.pos.y) {
                        cell.classList.add('player', pId === 'p1' ? 'p1-color' : 'p2-color');
                        cell.textContent = pId === 'p1' ? 'ğŸ‘¤' : 'ğŸ¤–';
                    }
                    board.appendChild(cell);
                }
            }
        }

        function move(pId, dx, dy) {
            if (!gameActive) return;
            const p = players[pId];
            const nx = p.pos.x + dx, ny = p.pos.y + dy;
            if (nx < 0 || nx >= CONFIG.cols || ny < 0 || ny >= CONFIG.rows) return;

            const boxKey = `${nx},${ny}`;
            if (p.boxes[boxKey]) {
                const bnx = nx + dx, bny = ny + dy;
                
                // æ¨å…¥é¡¶éƒ¨çš„é€»è¾‘
                if (bny === 0) {
                    const startX = Math.floor((CONFIG.cols - p.word.length) / 2);
                    const targetIdx = bnx - startX;
                    const box = p.boxes[boxKey];
                    
                    // æ ¸å¿ƒä¿®æ”¹ï¼šåªè¦å­—æ¯å¯¹åº”ä¸”è¯¥ä½ç½®æ²¡è¢«å¡«ï¼Œå°±å¯ä»¥æ¨å…¥
                    const isCorrectSlot = bnx >= startX && bnx < startX + p.word.length;
                    const isCorrectChar = isCorrectSlot && (box.char === p.word[targetIdx]);
                    const isAlreadyFilled = p.finishedIndices.includes(targetIdx);

                    if (!isCorrectChar || isAlreadyFilled) return; // æ¨ä¸åŠ¨

                    // æˆåŠŸæ¨å…¥
                    delete p.boxes[boxKey];
                    p.finishedIndices.push(targetIdx);
                    if (p.finishedIndices.length === p.word.length) {
                        p.score++;
                        document.getElementById(`${pId}-score`).textContent = p.score;
                        setTimeout(() => initPlayer(pId), 400);
                        return;
                    }
                } else {
                    // å¸¸è§„ç§»åŠ¨æ£€æŸ¥
                    if (bnx < 0 || bnx >= CONFIG.cols || bny < 0 || bny >= CONFIG.rows || p.boxes[`${bnx},${bny}`]) return;
                    const boxData = p.boxes[boxKey];
                    delete p.boxes[boxKey];
                    p.boxes[`${bnx},${bny}`] = boxData;
                }
            }
            p.pos.x = nx; p.pos.y = ny;
            render(pId);
        }

        window.addEventListener('keydown', e => {
            const k = e.key.toLowerCase();
            const p1Keys = { 'w': [0,-1], 's': [0,1], 'a': [-1,0], 'd': [1,0] };
            const p2Keys = { 'ArrowUp': [0,-1], 'ArrowDown': [0,1], 'ArrowLeft': [-1,0], 'ArrowRight': [1,0] };
            if (p1Keys[k]) move('p1', ...p1Keys[k]);
            if (p2Keys[e.key]) move('p2', ...p2Keys[e.key]);
        });

        function endGame() {
            gameActive = false;
            document.getElementById('result-modal').style.display = 'block';
            const winner = players.p1.score > players.p2.score ? "P1 èƒœåˆ©!" : players.p2.score > players.p1.score ? "P2 èƒœåˆ©!" : "å¹³å±€!";
            document.getElementById('winner-msg').textContent = winner;
            document.getElementById('final-stats').innerHTML = `P1 å¾—åˆ†: ${players.p1.score} <br> P2 å¾—åˆ†: ${players.p2.score}`;
        }
    </script>
</body>
</html>